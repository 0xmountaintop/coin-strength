<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Price Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chart-container {
            position: relative;
            height: 600px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        #coinSelector {
            min-width: 200px;
        }

        .range-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #daysRange {
            width: 80px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .date-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Cryptocurrency Price Trends</h1>
    
    <div class="controls">
        <select id="coinSelector" multiple>
            <option value="all" selected>All Coins</option>
        </select>
        <div class="date-inputs">
            <input type="date" id="startDate" class="date-input">
            <span>to</span>
            <input type="date" id="endDate" class="date-input">
        </div>
    </div>

    <div class="chart-container">
        <canvas id="priceChart"></canvas>
        <div class="loading" id="loadingIndicator" style="display: none;">
            <div class="loading-spinner"></div>
            <div>Loading data...</div>
        </div>
    </div>

    <script>
        const CHART_COLORS = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#7BC225', '#B56DFF'
        ];

        let priceChart = null;
        let selectedCoins = new Set(['all']);
        
        // Initialize date inputs with default values
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('startDate').value = formatDateForInput(thirtyDaysAgo);
        document.getElementById('endDate').value = formatDateForInput(today);
        
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }
        
        function formatDate(date) {
            return `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}`;
        }

        function getFilePath(date) {
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            return `results/${year}/${month}/${year}-${month}-${day}.csv`;
        }

        async function loadCSV(filePath) {
            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error('CSV file not found');
                }
                return await response.text();
            } catch (error) {
                console.warn('Error loading CSV:', error);
                return null;
            }
        }

        async function fetchHistoricalData() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const data = {};
            
            showLoading(true);
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const filePath = getFilePath(d);
                const csvText = await loadCSV(filePath);
                
                if (csvText) {
                    const rows = csvText.trim().split('\n');
                    const records = rows.slice(1).map(row => {
                        const [coin, totalValue] = row.split(',');
                        return { coin, totalValue: parseFloat(totalValue) };
                    });
                    
                    records.forEach(({ coin, totalValue }) => {
                        if (!data[coin]) {
                            data[coin] = [];
                        }
                        data[coin].push({
                            date: new Date(d),
                            value: totalValue
                        });
                    });
                }
            }
            
            showLoading(false);
            return data;
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function updateCoinSelector(coins) {
            const selector = document.getElementById('coinSelector');
            selector.innerHTML = '<option value="all">All Coins</option>';
            coins.forEach(coin => {
                const option = document.createElement('option');
                option.value = coin;
                option.textContent = coin;
                selector.appendChild(option);
            });
        }

        async function updateChart() {
            const data = await fetchHistoricalData();
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            const datasets = [];
            const coins = Object.keys(data).sort((a, b) => a.localeCompare(b));
            updateCoinSelector(coins);
            
            coins.forEach((coin, index) => {
                if (selectedCoins.has('all') || selectedCoins.has(coin)) {
                    datasets.push({
                        label: coin,
                        data: data[coin].map(d => ({
                            x: d.date,
                            y: d.value
                        })),
                        borderColor: CHART_COLORS[index % CHART_COLORS.length],
                        fill: false,
                        tension: 0.1
                    });
                }
            });
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    },
                    plugins: {
                        tooltip: {
                            position: 'nearest'
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d, yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value ($)'
                            }
                        }
                    }
                }
            });
        }

        // Event Listeners
        document.getElementById('coinSelector').addEventListener('change', (e) => {
            selectedCoins = new Set(
                Array.from(e.target.selectedOptions).map(option => option.value)
            );
            updateChart();
        });

        document.getElementById('startDate').addEventListener('change', updateChart);
        document.getElementById('endDate').addEventListener('change', updateChart);

        // Initial chart load
        updateChart();
    </script>
</body>
</html> 